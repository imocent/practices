<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:include="include :: head('编辑')"></head>
<body class="open-body">
<div class="layui-form" lay-filter="editForm">
    <div class="open-content">
        <div class="open-container">
            <input type="hidden" name="id" th:value="${bean?.id}"/>
            <input type="hidden" name="imgId" th:value="${bean?.imgId}"/>
            <div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
                <ul class="layui-tab-title">
                    <li class="layui-this">设置答题室</li>
                    <li>设置考场说明</li>
                    <li>设置考场图标</li>
                </ul>
                <div class="layui-tab-content">
                    <div class="layui-tab-item layui-show">
                        <div class="layui-form-item">
                            <label for="title" class="layui-form-label"><span class="yadmin-red">*</span>考场标题</label>
                            <div class="layui-input-block">
                                <input type="text" id="title" placeholder="请输入名称" name="title" th:value="${bean?.title}"
                                       lay-verify="required" lay-vertype="tips" autocomplete="off" class="layui-input"/>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="notes" class="layui-form-label">考场描述</label>
                            <div class="layui-input-block">
                                <input type="text" id="notes" placeholder="请输入说明" name="notes" th:value="${bean?.notes}"
                                       lay-vertype="tips" autocomplete="off" class="layui-input"/>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="ETI" class="layui-form-label">科目分类</label>
                            <div class="layui-input-block">
                                <input type="hidden" id="STI" name="subjectId" th:value="${bean?.subjectId}">
                                <input type="hidden" id="ETI" name="subjectName" th:value="${bean?.subjectName}">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="ENABLED" class="layui-form-label">考场状态</label>
                            <div class="layui-input-block">
                                <select id="ENABLED" name="enabled" lay-search>
                                    <option value="1">新建</option>
                                    <option value="2">发布</option>
                                    <option value="3">结束</option>
                                    <option value="4">归档</option>
                                    <option value="0">停用</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="EXAM_MODE" class="layui-form-label">答卷模式</label>
                            <div class="layui-input-block">
                                <select id="EXAM_MODE" name="examMode" lay-search>
                                    <option value="0">标准答题模式</option>
                                    <option value="1">随机抽取模式</option>
                                    <option value="2">习题练习模式</option>
                                    <option value="3">只读学习模式</option>
                                </select>
                            </div>
                        </div>
                        <!-- 答题限制 -->
                        <fieldset class="layui-elem-field layui-field-title">
                            <legend>答题限制</legend>
                        </fieldset>
                        <div class="layui-form-item">
                            <label for="EXAMINEE_MODE" class="layui-form-label">答题人员</label>
                            <div class="layui-input-block">
                                <select ID="EXAMINEE_MODE" name="examineeMode">
                                    <option value="false">任何人员</option>
                                    <option value="true">指定人员</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="TIME_MODE" class="layui-form-label">有效时间</label>
                            <div class="layui-input-block">
                                <select ID="TIME_MODE" name="timeMode">
                                    <option value="false">永久</option>
                                    <option value="true">限时</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="timeLen" class="layui-form-label">答题时长</label>
                            <div class="layui-input-block">
                                <input type="text" id="timeLen" name="timeLen" lay-affix="number" placeholder="请输入答题时长"
                                       step="1" min="1" max="200" th:value="${bean?.timeLen}" class="layui-input"/>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label FOR="EXAMINEE_COUNT" class="layui-form-label">答题次数</label>
                            <div class="layui-input-block">
                                <select ID="EXAMINEE_COUNT" name="examineeCount">
                                    <option value="0">不限次数</option>
                                    <option value="1">1数</option>
                                    <option value="2">2次</option>
                                    <option value="3">3次</option>
                                    <option value="4">4次</option>
                                    <option value="5">5次</option>
                                    <option value="10">10次</option>
                                    <option value="15">15次</option>
                                    <option value="20">20次</option>
                                </select>
                            </div>
                        </div>
                        <!-- 答题展示 -->
                        <fieldset class="layui-elem-field layui-field-title">
                            <legend>答题展示</legend>
                        </fieldset>
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label for="SSM" class="layui-form-label">题目排序</label>
                                <div class="layui-input-inline">
                                    <input id="SSM" type="checkbox" lay-filter="switch" name="subjectSortMode" lay-skin="switch"
                                           lay-text="固定|随机" th:checked="${bean?.subjectSortMode}" value="0"/>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label for="SOSM" class="layui-form-label">选项排序</label>
                                <div class="layui-input-inline">
                                    <input id="SOSM" type="checkbox" lay-filter="switch" name="subjectOptSortMode" lay-skin="switch"
                                           lay-text="固定|随机" th:checked="${bean?.subjectOptSortMode}" value="0"/>
                                </div>
                            </div>
                        </div>
                        <!-- 阅卷/成绩发布 -->
                        <fieldset class="layui-elem-field layui-field-title">
                            <legend>阅卷/成绩发布</legend>
                        </fieldset>
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label for="markMode" class="layui-form-label">阅卷类型</label>
                                <div class="layui-input-inline">
                                    <input id="markMode" type="checkbox" lay-filter="switch" name="markMode" lay-skin="switch"
                                           lay-text="自动完成|人工阅卷" th:checked="${bean?.markMode}" value="0"/>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label for="ADJUDGE_MODE" class="layui-form-label">阅卷时间</label>
                                <div class="layui-input-inline">
                                    <input id="ADJUDGE_MODE" type="checkbox" lay-filter="switch" name="adjudgeMode" lay-skin="switch"
                                           lay-text="用户交卷后|全场收卷后" th:checked="${bean?.adjudgeMode}" value="0"/>
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="MARK_TIME_MODE" class="layui-form-label">成绩发布时间</label>
                            <div class="layui-input-block">
                                <select id="MARK_TIME_MODE" name="markTimeMode">
                                    <option value="2">答卷阅卷后</option>
                                    <option value="1">全场阅卷后</option>
                                    <option value="0">不发布</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label for="MARK_SHOW_MODE" class="layui-form-label">发布成绩类型</label>
                            <div class="layui-input-block">
                                <select id="MARK_SHOW_MODE" name="markShowMode">
                                    <option value="0">得分&答案</option>
                                    <option value="1">得分</option>
                                    <option value="2">答案</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="layui-tab-item layui-form-item layui-form-text">
                        <label for="content" class="layui-form-label">考场说明</label>
                        <div class="layui-input-block">
                        <textarea id="content" name="content" placeholder="请输入说明" class="layui-textarea"
                                  th:text="${bean?.content}"></textarea>
                        </div>
                    </div>
                    <div class="layui-tab-item layui-form-item">
                        <label class="layui-form-label">考场图标</label>
                        <div class="layui-input-block">
                            <button type="button" class="layui-btn" id="ID-upload-btn">
                                <i class="layui-icon layui-icon-upload"></i> 单图片上传
                            </button>
                            <div style="width: 132px;">
                                <div class="layui-upload-list">
                                    <img class="layui-upload-img" id="ID_IMG" width="200" height="200" th:src="${image?:'/images/exam.png'}">
                                    <div id="ID-upload-text"></div>
                                </div>
                                <div class="layui-progress layui-progress-big" lay-showPercent="yes" lay-filter="filter-demo">
                                    <div class="layui-progress-bar" lay-percent=""></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="open-bottom">
        <div class="open-button-container">
            <button class="layui-btn layui-btn-normal btn-w100" lay-submit="" lay-filter="submit-form">保存</button>
        </div>
    </div>
</div>
<script>
    layui.use(['jquery', 'form', 'layer', 'element', 'upload', 'layChoice', 'layEditor'],
        function ($, form, layer, element, upload, choice, editor) {
            // 回填数据
            form.val('editForm', {
                enabled: "[[${bean?.enabled?:0}]]",
                examMode: "[[${bean?.examMode?:0}]]",
                examineeMode: "[[${bean?.examineeMode?:false}]]",
                timeMode: "[[${bean?.timeMode?:false}]]",
                examineeCount: "[[${bean?.examineeCount?:0}]]",
                markTimeMode: "[[${bean?.markTimeMode?:0}]]",
                markShowMode: "[[${bean?.markShowMode?:0}]]"
            });
            form.render();

            choice.render({elem: '#STI', labelElem: '#ETI', url: '/subjects',});

            editor.init({
                elem: '#content',
                uploadUrl: 'https://upload-z1.qiniup.com',
                videoUploadUrl: 'https://upload-z1.qiniup.com',
                videoUploadSize: '102400',
                uploadSize: '',
                style: 'fangge',
            });

            upload.render({
                elem: '#ID-upload-btn',  //绑定元素
                url: '/admin/file/doUpload',
                before: function (obj) {
                    obj.preview(function (index, file, result) {
                        $('#ID_IMG').attr('src', result); // 图片链接（base64）
                    });
                    element.progress('filter-demo', '0%'); // 进度条复位
                    layer.msg('上传中', {icon: 16, time: 0});
                },
                done: function (res) {
                    console.log(res)
                    if (res.code == -1) {
                        layer.msg(res.msg, {icon: 5, time: 2000});
                    }
                },
                error: function () {
                    layer.msg("上传文件失败", {icon: 5, time: 2000});
                },
                progress: function (n, elem, e) {
                    element.progress('filter-demo', n + '%');
                }
            });

            $(function () {
                form.on('switch', function (data) {
                    data.elem.value = data.elem.checked ? '1' : '0';
                });

                $('input[lay-skin="switch"]').each(function () {
                    var $this = $(this);
                    if ($this.prop('checked')) {
                        $this.val('1');
                    } else {
                        $this.val('0');
                    }
                });

                form.render('checkbox');
            });

            form.on('submit(submit-form)', function (obj) {
                var formData = obj.field;
                $('input[lay-skin="switch"]').each(function () {
                    var $this = $(this);
                    formData[$this.attr('name')] = $this.val();
                });
                $.post('/admin/lms/exam/room/save', obj.field, function (data) {
                    advices(data, parent);
                }, 'json').fail(function (event) {
                    toError(event);
                });
            });
        });
</script>
</body>
</html>