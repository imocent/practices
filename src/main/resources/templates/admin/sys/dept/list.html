<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:include="include :: head('部门列表')"></head>
<body>
<div style="padding: 20px; background-color: #F2F2F2;height:100%;">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md3">
            <div class="layui-card">
                <div class="layui-card-header">部门树</div>
                <div class="layui-card-body" id="toolbarDiv">
                    <ul id="deptTree" class="dtree" data-id="0"></ul>
                </div>
            </div>
        </div>
        <div class="layui-col-md9">
            <div class="layui-card">
                <div class="layui-card-header" id="card-header">部门列表</div>
                <div class="layui-card-body">
                    <form class="layui-form yadmin-search-area input">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label for="keywords" class="layui-form-label">关键字</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="keywords" autocomplete="off" placeholder="输入名称" id="keywords"
                                           class="layui-input"/>
                                </div>
                                <button lay-submit="" lay-filter="search" class="layui-btn layui-btn-sm layui-btn-primary table-action">
                                    <i class="layui-icon layui-icon-search"></i>
                                </button>
                                <button type="reset" lay-filter="search" class="layui-btn layui-btn-sm layui-btn-primary table-action">
                                    <i class="layui-icon layui-icon-refresh"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                    <script type="text/html" id="toolbar">
                        <button type="button" class="layui-btn layui-btn-xs layui-btn-normal" lay-event="add">
                            <i class="layui-icon layui-icon-addition">新增</i>
                        </button>
                        <button type="button" class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">
                            <i class="layui-icon layui-icon-delete" title="删除">删除</i>
                        </button>
                    </script>
                    <table class="layui-hide" id="table-list"></table>
                    <script type="text/html" id="column-toolbar">
                        <button type="button" class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit">
                            <i class="layui-icon layui-icon-edit" title="编辑">编辑</i>
                        </button>
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    layui.use(['jquery', 'table', 'dtree', 'form'], function ($, table, dtree, form) {
        dtree.render({
            elem: "#deptTree",
            url: "/admin/dept/tree",
            method: "post",
            dataStyle: "layuiStyle",
            toolbar: false,  // 右键工具栏
            menubar: true,  // 树上方工具栏, 展开、收缩、刷新、搜索等
            dataFormat: "list",
            ficon: ["1", "-1"],
            response: {
                statusCode: 0,
                message: "msg",
                level: "level",
                title: "name"
            }
        });

        dtree.on("node('deptTree')", function (obj) {
            table.reload('table-list', {
                where: {
                    deptId: obj.param.nodeId
                }
            });
        });
        table.render({
            elem: '#table-list',
            url: '/admin/dept/list',
            method: 'post',
            dataType: 'JSON',
            page: true,
            toolbar: '#toolbar',
            cols: [ [
                {type: 'checkbox'},
                {field: 'simpleName', title: '简称', width: 80},
                {field: 'fullName', title: '全称', minWidth: 80},
                {field: 'sort', title: '排序', minWidth: 80},
                {field: 'notes', title: '备注', minWidth: 160},
                {fixed: 'right', title: '操作', align: 'center', toolbar: '#column-toolbar'}
            ] ]
        });
        // 工具条点击事件
        table.on('toolbar', function (obj) {
            if (obj.event === 'add') {
                editView("/admin/dept/edit", "新增部门");
            } else if (obj.event === 'del') {
                layer.confirm('真的删除行么?', function (index) {
                    let selectData = table.checkStatus('table-list').data;
                    if (selectData.length > 0) {
                        let idsArray = [];
                        for (let i = 0; i < selectData.length; i++) {
                            idsArray.push(selectData[i].id);
                        }
                        let ids = idsArray.toString();
                        deleteReq(ids, '/admin/dept/del')
                        layer.close(index);
                    }
                });
            }
        });

        // 行点击事件
        table.on('tool', function (obj) {
            let data = obj.data, event = obj.event;
            if (event === 'edit') {
                editView("/admin/dept/edit?id=" + data.id, "编辑部门");
            }
        });

        form.on('submit(search)', function (form) {
            table.reload('table-list', {
                where: form.field
            });
            return false;
        });
    });
</script>
</body>
</html>