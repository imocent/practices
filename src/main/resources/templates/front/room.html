<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:include="include :: head('做题吧 - 答题室')"></head>
<body>
<th:block th:include="include :: f_header"></th:block>
<div class="layui-container layui-fluid" style="margin-top:10px">
    <div class="layui-row layui-col-space20">
        <!-- 左侧：课程信息 -->
        <div class="layui-col-md8">
            <div class="layui-card">
                <div class="layui-card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)">
                    <i class="layui-icon layui-icon-template-1"></i>
                    <span style="color: #fff;" th:text="${room?.title}">实战课程</span>
                </div>
                <div class="layui-card-body" id="ID-body" th:text="${room?.content}">
                    <div class="room-body">
                        <ul class="layui-timeline">
                            <li class="layui-timeline-item">
                                <i class="layui-icon layui-timeline-axis">&#xe63f;</i>
                                <div class="layui-timeline-content layui-text">
                                    <h3 class="layui-timeline-title">Vue 3.0 核心特性</h3>
                                    <p>全面讲解Composition API、响应式系统、Teleport、Fragments等Vue 3.0新特性</p>
                                </div>
                            </li>
                            <li class="layui-timeline-item">我是广告位</li>
                        </ul>
                    </div>
                </div>
                <div class="layui-card-body layui-hide" id="ID-flow">
                    <div class="layui-form room-body">
                        <input type="hidden" name="duration" id="duration" th:value="${duration?:0}"/>
                        <input type="hidden" name="enabled" id="enabled" value="1"/>
                        <input type="hidden" name="examRoomId" id="examRoomId" th:value="${room?.id}"/>
                        <input type="hidden" name="examRoomName" id="examRoomName" th:value="${room?.title}"/>
                        <input type="hidden" name="subjectName" id="subjectName" th:value="${room?.subjectName}"/>
                        <div class="question-container" th:id="${#strings.concat('q_', qStat.index)}" th:each="q,qStat : ${questions}">
                            <span th:text="${qStat.index+1}"></span>.
                            <div class="question-content" th:text="${q?.CONTENT}">问题</div>
                            <ul class="options">
                                <li th:each="info,infoStat : ${#strings.arraySplit(q?.answer_info, ';')}">
                                    <input th:with="parts=${#strings.arraySplit(info?.trim(), '|')},isCheck=${parts[0] == q?.checked?true:false}"
                                           th:name="${#strings.concat('q_', q.ID,'_',parts[2])}" th:value="${parts[0]}" th:text="${parts[1]}"
                                           th:data-a="${parts[0]}" th:data-b="${q?.checked}" th:checked="${isCheck}" type="radio"
                                           class="layui-input"/>
                                </li>
                            </ul>
                        </div>
                        <!-- 使用负边距消除缝隙 -->
                        <div class="room-footer layui-row">
                            <div class="layui-col-md4">
                                <i class="layui-icon layui-icon-time"> <span id="timer">00:00:00</span></i>
                            </div>
                            <div class="layui-col-md8">
                                <button class="layui-btn layui-btn-normal" data-id="check" lay-submit lay-filter="sbt_form">检查</button>
                                <button class="layui-btn layui-btn-warm" data-id="save" lay-submit lay-filter="sbt_form">保存</button>
                                <button class="layui-btn layui-btn-danger" data-id="submit" lay-submit lay-filter="sbt_form">交卷</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 右侧：答题室信息 -->
        <div class="layui-col-md4">
            <div class="layui-card">
                <div class="layui-card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)">
                    <i class="layui-icon layui-icon-cols"></i><span style="color:#FFF;"> 答题室</span>
                    <span class="layui-badge" style="float:right;" th:text="${room?.timeMode==1?'限时答题':'永久有效'}">永久有效</span>
                </div>
                <div class="room layui-card-body">
                    <ul class="layui-row layui-col-space10" th:with="util=${T(com.fit.util.DictRoomUtil)}">
                        <li class="layui-col-md12">
                            <span class="layui-col-xs2 layui-col-sm2 layui-col-md2">状态:</span>
                            <span class="layui-col-xs10 layui-col-sm10 layui-col-md10" th:text="${util.getDict(0, room?.enabled)}"></span>
                        </li>
                        <li class="layui-col-md12">
                            <span class="layui-col-xs2 layui-col-sm2 layui-col-md2">类型:</span>
                            <span class="layui-col-xs10 layui-col-sm10 layui-col-md10" th:text="${util.getDict(1, room?.examMode)}"></span>
                        </li>
                        <li class="layui-col-md12">
                            <span class="layui-col-xs2 layui-col-sm2 layui-col-md2">条件:</span>
                            <span class="layui-col-xs10 layui-col-sm10 layui-col-md10"
                                  th:text="${util.getDict(2, room?.examineeMode)}"></span>
                        </li>
                        <li class="layui-col-md12">
                            <span class="layui-col-xs2 layui-col-sm2 layui-col-md2">分类:</span>
                            <span class="layui-col-xs10 layui-col-sm10 layui-col-md10" th:text="${room?.subjectName}">默认答题室</span>
                        </li>
                    </ul>
                    <div class="layui-card-body laytable-cell-space" style="background: #f8f8f8; margin: 8px 0;">
                        <div style="font-size: 32px; color: #1E9FFF; font-weight: bold;">1/1</div>
                        <div style="color: #666;">进入答题室人数</div>
                    </div>
                    <button class="layui-btn layui-btn-fluid layui-btn-primary layui-border-red" th:data-room-id="${room.id}">
                        <i class="layui-icon">&#xe652; 开始答题</i>
                        <i class="layui-icon layui-hide">&#xe6cc; 结束答题</i>
                    </button>
                </div>
            </div>
            <div class="layui-card" style="margin-top: 20px;">
                <div class="layui-card-header"><i class="layui-icon">&#xe702; 答题须知</i></div>
                <div class="layui-card-body">
                    <div class="layui-collapse">
                        <div class="layui-colla-item">
                            <h2 class="layui-colla-title">答题规则</h2>
                            <div class="layui-colla-content layui-show">
                                <p>1. 答题时长限制为<span th:text="${room?.timeLen}"></span>分钟，超时自动提交</p>
                                <p>2. 答题过程中不可切换页面，否则可能被判定为异常</p>
                                <p>3. 每人仅有一次答题机会，请谨慎作答</p>
                            </div>
                        </div>
                        <div class="layui-colla-item">
                            <h2 class="layui-colla-title">评分标准</h2>
                            <div class="layui-colla-content">
                                <p>1. 答题正确率需达到60%以上方可通过</p>
                                <p>2. 答题结束后可立即查看分数和解析</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<th:block th:include="include :: f_footer"></th:block>
<!-- 引入 LayUI JS -->
<script src="/js/layui.js"></script>
<script>
    layui.use(['jquery', 'element', 'form'], function ($, element, form) {
        // 初始化折叠面板
        element.render('collapse');

        var intervalId, totalSeconds = parseInt($("#duration").val()) || 0;
        $('.room').on('click', '.layui-btn', function (e) {
            e.stopPropagation();
            var $btn = $(this);
            var roomId = $btn.data('room-id');
            $btn.toggleClass('layui-border-red layui-border-green');// 切换两个图标的显示状态
            $btn.find('i').toggleClass('layui-hide');
            // 根据当前状态执行不同逻辑
            if ($btn.hasClass('layui-border-green')) {
                console.log('开始答题 - 房间ID:', roomId);
                intervalId = setInterval(function () {
                    totalSeconds += 1000;
                    $("#timer").text(new Date(totalSeconds).Format("HH:mm:ss", true));
                    $("#duration").val(totalSeconds);
                }, 1000);
                $('#ID-body').addClass('layui-hide');
                $('#ID-flow').removeClass('layui-hide');
            } else {
                clearInterval(intervalId);
                intervalId = null;
                totalSeconds = 0;
                console.log('结束答题 - 房间ID:', roomId);
                $('#ID-body').removeClass('layui-hide');
                $('#ID-flow').addClass('layui-hide');
                $('.question-container').each(function (index) {
                    $(this).removeClass('has-error');
                });
            }
        });

        function validateExamForm() {
            var ids = [];
            $('.question-container').each(function (index) {
                var hasAnswer = $(this).find('input[type="radio"]:checked').length > 0;
                if (!hasAnswer) {  // 没有答案
                    ids.push('q_' + index);
                    $(this).addClass('has-error');
                } else {  // 有答案
                    $(this).removeClass('has-error');
                }
            });
            return {isValid: ids.length === 0, ids: ids};
        }

        form.on('submit(sbt_form)', function (obj) {
            $(this).prop('disabled', true).addClass('layui-btn-disabled');
            switch (obj.elem.getAttribute('data-id')) {
                case 'check':
                    var verify = validateExamForm();
                    if (!verify.isValid) {
                        document.getElementById(verify.ids[0]).scrollIntoView({behavior: 'smooth', block: 'start'});
                        return false;
                    }
                    break;
                case 'save':
                    $("#enabled").val(0);
                case 'submit':
                    $.post('/user/answerSave', obj.field, function (data) {
                        if (data.code === -1) {
                            layer.msg(data.msg, {icon: 5, time: 1000});
                        } else {
                            layer.msg(data.msg, {icon: 6, time: 2000, end: function () {window.location.reload();}});
                        }
                    }, 'json').fail(function (event) {
                        layer.msg(event.responseText, {icon: 5, time: 1000});
                    });
                    break;
            }
            $(this).prop('disabled', true).removeClass('layui-btn-disabled');
            return false;
        });

        $(document).on('change', 'input[type="radio"]', function () {
            var $questionContainer = $(this).closest('.question-container');
            if ($questionContainer.find('input[type="radio"]:checked').length > 0) {
                $questionContainer.removeClass('has-error');
            }
        });
    });
</script>
</body>
</html>
